{% extends 'base.html' %}

{% block title %}{{ team.name }} Dashboard{% endblock %}

{% block content %}

<div>
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <div id="flash-messages" class="flash-messages"> 
            {% for message in messages %}
                <div class="flash-message">{{ message }}</div>
            {% endfor %}
            </div>
        {% endif %}
    {% endwith %}
</div>
<div class="top">
    <div class="menu" id="menu-btn" style="width: 2rem; height: 2rem;">
        <svg xmlns="http://www.w3.org/2000/svg" fill="currentcolor" class="bi bi-list" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
        </svg>
    </div>
    <h1>{{team.name}} Dashboard</h1>
</div>

<style>
    @keyframes fatigue{100%{stroke-dashoffset: {{circle[0]}};}}
    @keyframes jh{100%{stroke-dashoffset: {{circle[1]}};}}
    @keyframes performance{100%{stroke-dashoffset: {{circle[2]}};}}
    @keyframes power{100%{stroke-dashoffset: {{circle[3]}};}}
</style>

<div class="date">
    <input type="text" id="datePicker">
</div>

{% if current_user.type in ['admin', 'peak'] %}
<div class="btn-cluster">
    <a class="btn" href="{{ url_for('main.new_note') }}">
        <h2> New Note</h2>
    </a>
    <a class="btn" href="{{ url_for('main.notes_dashboard') }}">
        <h2> Notes Dashboard</h2>
    </a>
</div>
{% endif %}

<div class="insights">
    <div class="metric"onclick="window.location.href='/team/rRFD/{{ team.id }}';" style="cursor: pointer;">
        <span> Fatigue</span>
        <div class="middle">
            <div class="left">
                <h3>Fatigue data</h3>
                <h1>{{ for_avg[0] }}</h1>
            </div>
            <div class="progress">
                <div class="outer">
                    <div class="inner">
                        <div class="num">{{per[0]}}%</div>
                    </div>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" version="1.1">
                    <circle style="animation: fatigue 1s linear forwards;"  cx='46' cy='46' r='40' stroke-linecap="round"  />
                </svg>
            </div>
        </div>
        <small class="text-muted">(N/s)</small>
    </div>
    <!-- --------------- End of Fatigue -------------- -->


    <div class="metric" onclick="window.location.href='/team/jh/{{ team.id }}';" style="cursor: pointer;">
        <span> Jump Height</span>
        <div class="middle">
            <div class="left">
                <h3>Jump Height data</h3>
                <h1>{{ for_avg[1] }}</h1>
            </div>
            <div class="progress">
                <div class="outer">
                    <div class="inner">
                        <div class="num">{{per[1]}}%</div>
                    </div>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" version="1.1">
                    <circle style="animation: jh 1s linear forwards;"  cx='46' cy='46' r='40' stroke-linecap="round"  />
                </svg>
            </div>
        </div>
        <small class="text-muted">(Meters)</small>
    </div>
    <!-- --------------- End of Jump Height -------------- -->


    <div class="metric" onclick="window.location.href='/team/mrsi/{{ team.id }}';" style="cursor: pointer;">
        <span> Performance</span>
        <div class="middle">
            <div class="left">
                <h3>Performance data</h3>
                <h1>{{ for_avg[2] }}</h1>
            </div>
            <div class="progress">
                <div class="outer">
                    <div class="inner">
                        <div class="num">{{per[2]}}%</div>
                    </div>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" version="1.1">
                    <circle style="animation: performance 1s linear forwards;"  cx='46' cy='46' r='40' stroke-linecap="round"  />
                </svg>
            </div>
        </div>
        <small class="text-muted">Relative units</small>
    </div>
    <!-- --------------- End of Performance -------------- -->


    <div class="metric" onclick="window.location.href='/team/ppf/{{ team.id }}';" style="cursor: pointer;">
        <span> Power</span>
        <div class="middle">
            <div class="left">
                <h3>Power data</h3>
                <h1>{{ for_avg[3] }}</h1>
            </div>
            <div class="progress">
                <div class="outer">
                    <div class="inner">
                        <div class="num">{{per[3]}}%</div>
                    </div>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" version="1.1">
                    <circle style="animation: power 1s linear forwards;"  cx='46' cy='46' r='40' stroke-linecap="round"  />
                </svg>
            </div>
        </div>
        <small class="text-muted">(Newtons)</small>
    </div>
    <!-- --------------- End of Power -------------- -->
</div>
<!-- --------------- End of Insights -------------- -->

<div class="athletes">
    <h2> Athletes in the Team</h2>
    <table>
        <!-- head of table -->
        <thead>
            <tr>
                <th >Athlete Name</th>
                <th>Position</th>
                <th>Status</th>
                <th>Notes</th>
            </tr>
        </thead>

        <!-- table body -->
        <tbody>
            {% for athlete in athletes %}

            <tr>
                <td>
                    <a href="/athlete/{{ athlete.id }}">
                        {{ athlete.first_name }} {{ athlete.last_name }}
                    </a>
                </td>
                <td>
                    <select style="cursor: pointer;" id="positionSelect{{ athlete.id }}" onchange="updatePosition({{ athlete.id }})">
                        <option value="Forward" {% if athlete.position == "Forward" %}selected{% endif %}>Forward</option>
                        <option value="Winger" {% if athlete.position == "Winger" %}selected{% endif %}>Winger</option>
                        <option value="Midfilder" {% if athlete.position == "Midfilder" %}selected{% endif %}>Midfilder</option>
                        <option value="Defender" {% if athlete.position == "Defender" %}selected{% endif %}>Defender</option>
                        <option value="GoalKeaper" {% if athlete.position == "GoalKeaper" %}selected{% endif %}>GoalKeaper</option>
                        <option value="Battery" {% if athlete.position == "Battery" %}selected{% endif %}>Battery</option>
                        <option value="Infield" {% if athlete.position == "Infield" %}selected{% endif %}>Infield</option>
                        <option value="Outfield" {% if athlete.position == "Outfield" %}selected{% endif %}>Outfield</option>
                        <option value="Rower" {% if athlete.position == "Rower" %}selected{% endif %}>Rower</option>
                        <option value="Coxswain" {% if athlete.position == "Coxswain" %}selected{% endif %}>Coxswain</option>
                        <option value="Other" {% if athlete.position == "Other" %}selected{% endif %}>Other</option>
                    </select>
                </td>
                <td>
                    {% if athlete.status == 0 %}
                    <p class="card-text" style="color: var(--color-success);">Clear</p>
                    {% elif athlete.status == 1 %}
                    <p class="card-text" style="color: var(--color-warning);">Warning</p>
                    {% else %}
                    <p class="card-text" style="color: var(--color-danger);">Not Clear</p>
                    {% endif %}
                </td>
                <td>
                    {% if athlete.received_notes %}
                    {{ athlete.received_notes[-1].text if athlete.received_notes[-1].visible else "No visible notes" }}
                    {% else %}
                    No notes received
                    {% endif %}
                </td> 

            </tr>
            
            {% endfor %}
        </tbody>
    </table>
</div>
<!-- --------------- End of Athletes -------------- -->
{% endblock %}

{% block extra_js %}

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
    var availableDates = {{ distinct_dates | tojson | safe }};

    flatpickr("#datePicker", {
        enableTime: false,
        dateFormat: "Y-m-d",
        defaultDate: "{{ date }}",
        enable: availableDates,
        onChange: function(selectedDates, dateStr, instance) {
            const id = '{{ team.id }}';
            window.location.href = `/team/${id}?date=${dateStr}`;
        }
    });

</script>
<script>
    //function to update athletes position
    function updatePosition(athleteId) {
            var selectElement = document.getElementById("positionSelect" + athleteId);
            var position = selectElement.value;

            // Send AJAX request to update athlete position
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/update_position/" + athleteId, true);
            xhr.setRequestHeader("Content-Type", "application/json");

            xhr.onreadystatechange = function () {
            if (xhr.readyState === 4 && xhr.status === 200) {
                var response = JSON.parse(xhr.responseText);
                if (response.success) {
                alert("Position updated successfully");
                } else {
                alert("Failed to update position");
                }
            }
            };

            var data = JSON.stringify({ position: position });
            xhr.send(data);
        }
</script>
{% endblock %}